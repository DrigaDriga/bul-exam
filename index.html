<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Тренажёр тестов</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:16px;max-width:980px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;align-items:center}
    select,button{padding:10px 12px;font-size:14px}
    .card{border:1px solid #ddd;border-radius:14px;padding:14px;margin:12px 0}
    .opt{display:block;margin:8px 0;padding:10px;border:1px solid #ddd;border-radius:10px;cursor:pointer}
    .opt input{margin-right:10px}
    .muted{color:#666}
    .good{color:#0a7a0a}
    .bad{color:#b00020}
    .top{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #ddd;border-radius:999px}
    @media (max-width:520px){
      body{margin:10px}
      select,button{width:100%}
      .row{gap:8px}
    }
  </style>
</head>
<body>
  <div class="top">
    <h2 style="margin:0">Тренажёр</h2>
    <div class="muted" id="status"></div>
  </div>

  <div class="row">
    <label>
      База:
      <select id="sheetSelect"></select>
    </label>

    <label>
      Режим:
      <select id="modeSelect">
        <option value="random30">30 вопросов (случайные)</option>
        <option value="all">Все вопросы (случайный порядок + мгновенная проверка)</option>
      </select>
    </label>

    <button id="startBtn">Начать</button>
    <button id="continueBtn" disabled>Продолжить</button>
    <button id="resetBtn" disabled>Сброс</button>
  </div>

  <div class="row muted">
    <span class="pill">Рандом: всегда</span>
    <span class="pill">Ответ в JSON: 0-based</span>
    <span class="pill">Прогресс: сохраняется</span>
  </div>

  <div id="app"></div>

<script>
/** 1) ВСТАВЬ URL Web App */
const API_BASE = "https://script.google.com/macros/s/AKfycbz03w7J7o4jsfJ-HGx_OnjTFGlG-wXWGcBfLjkl_ZiLKPhPv6aHAGQdnK0VtqfufMrD/exec";

/** 2) УКАЖИ ДВА ЛИСТА: value = имя листа, label = как показывать жене */
const SHEETS = [
  { value: "standart",      label: "Тест стандарт" },
  { value: "expert",         label: "Тест эксперт" },
  { value: "lead_standart", label: "Lead стандарт" },
  { value: "lead_expert",   label: "Lead эксперт" }
];

const STORAGE_KEY = "quiz_state_v1";

let allQuestions = [];
let quiz = [];
let idx = 0;
let answers = new Map(); // id -> chosenIndex
let meta = { sheet: null, mode: null, startedAt: null };

const elApp = document.getElementById('app');
const elStatus = document.getElementById('status');

function escapeHtml(s){
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
    .replaceAll('"','&quot;').replaceAll("'","&#039;");
}

function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

function shuffleQuestionOptions(q){
  // создаём массив пар: {text, correct}
  const pairs = q.options.map((text, i) => ({
    text,
    correct: i === q.answer
  }));

  // перемешиваем
  const shuffled = shuffle(pairs);

  // собираем обратно
  const options = shuffled.map(p => p.text);
  const answer = shuffled.findIndex(p => p.correct);

  return {
    ...q,
    options,
    answer
  };
}

function pickQuiz(mode){
  // сначала перемешиваем порядок вопросов
  let base = shuffle(allQuestions);

  // если режим 30 — обрезаем
  if(mode !== 'all'){
    base = base.slice(0, Math.min(30, base.length));
  }

  // перемешиваем варианты внутри каждого вопроса
  return base.map(shuffleQuestionOptions);
}

async function loadSheet(sheet){
  const url = `${API_BASE}?sheet=${encodeURIComponent(sheet)}`;
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error("Ошибка загрузки базы");
  const data = await res.json();
  if(!data.ok) throw new Error(data.error || "Ошибка данных");
  return data.items; // {id,q,options[],answer(0-based)}
}

function setStatus(){
  if(!quiz.length){ elStatus.textContent = ""; return; }
  const answered = [...answers.keys()].length;
  elStatus.textContent = `Вопрос ${idx+1}/${quiz.length} · Отвечено ${answered}/${quiz.length}`;
}

function saveState(){
  if(!quiz.length) return;
  const state = {
    meta,
    idx,
    quizIds: quiz.map(q=>q.id),
    // answers: [ [id, chosenIndex], ... ]
    answers: [...answers.entries()]
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  updateContinueBtn();
}

function clearState(){
  localStorage.removeItem(STORAGE_KEY);
  updateContinueBtn();
}

function updateContinueBtn(){
  const has = !!localStorage.getItem(STORAGE_KEY);
  document.getElementById('continueBtn').disabled = !has;
}

function render(){
  if(!quiz.length){
    elApp.innerHTML = `<div class="card">Нажмите «Начать». Если есть сохранённая попытка — «Продолжить».</div>`;
    setStatus();
    return;
  }

  const mode = meta.mode;
  const q = quiz[idx];
  const chosen = answers.get(q.id);

  setStatus();

  const optsHtml = q.options.map((text, i)=>`
    <label class="opt">
      <input type="radio" name="opt" value="${i}" ${chosen===i?'checked':''} />
      ${escapeHtml(text)}
    </label>
  `).join('');

  elApp.innerHTML = `
    <div class="card">
      <div><b>${escapeHtml(q.q)}</b></div>
      <div class="muted" style="margin-top:6px">ID: ${escapeHtml(q.id)}</div>

      <div style="margin-top:12px">${optsHtml}</div>

      <div id="feedback" style="margin-top:10px"></div>

      <div class="row" style="margin-top:10px">
        <button id="prevBtn" ${idx===0?'disabled':''}>Назад</button>
        <button id="nextBtn" ${idx===quiz.length-1?'disabled':''}>Вперёд</button>
        <button id="finishBtn">Завершить</button>
      </div>
    </div>
  `;

  const fb = document.getElementById('feedback');

  function showFeedback(){
    const pick = answers.get(q.id);
    if(typeof pick !== 'number') { fb.innerHTML = ""; return; }
    const ok = pick === q.answer;
    fb.innerHTML = ok
      ? `<div class="good">Верно ✅</div>`
      : `<div class="bad">Неверно ❌ Правильный: ${escapeHtml(q.options[q.answer])}</div>`;
  }

  // обработка выбора
  elApp.querySelectorAll('input[name="opt"]').forEach(r=>{
    r.addEventListener('change', e=>{
      answers.set(q.id, Number(e.target.value));
      if(mode === 'all') showFeedback(); // мгновенная проверка только в режиме all
      saveState();
      setStatus();
    });
  });

  // если уже отвечено — в режиме all показываем сразу при открытии вопроса
  if(mode === 'all') showFeedback();

  document.getElementById('prevBtn').onclick = ()=>{ idx--; saveState(); render(); };
  document.getElementById('nextBtn').onclick = ()=>{ idx++; saveState(); render(); };
  document.getElementById('finishBtn').onclick = ()=>{ renderResult(); };
}

function renderResult(){
  let correct = 0, answered = 0;
  const wrong = [];

  quiz.forEach(q=>{
    const pick = answers.get(q.id);
    if(typeof pick === 'number'){
      answered++;
      if(pick === q.answer){
        correct++;
      } else {
        wrong.push(q);
      }
    }
  });

  const total = quiz.length;
  const pct = total ? Math.round(correct/total*100) : 0;

  elApp.innerHTML = `
    <div class="card">
      <h3 style="margin-top:0">Результат</h3>
      <div><b>${correct}</b> / ${total} (${pct}%)</div>
      <div class="muted" style="margin-top:6px">
        Отвечено: ${answered} / ${total}
      </div>

      <div class="row" style="margin-top:12px">
        <button id="againBtn">Новая попытка</button>
        <button id="wrongBtn" ${wrong.length ? "" : "disabled"}>
          Повторить ошибки (${wrong.length})
        </button>
        <button id="clearBtn">Очистить сохранение</button>
      </div>
    </div>
  `;

  document.getElementById('againBtn').onclick = ()=>{
    idx = 0;
    answers = new Map();
    meta.startedAt = new Date().toISOString();
    saveState();
    render();
  };

  document.getElementById('wrongBtn').onclick = ()=>{
    startWrongMode(wrong);
  };

  document.getElementById('clearBtn').onclick = ()=>{
    clearState();
    quiz = [];
    idx = 0;
    answers = new Map();
    meta = { sheet: null, mode: null, startedAt: null };
    document.getElementById('resetBtn').disabled = true;
    render();
  };
}

function startWrongMode(wrongQuestions){
  if(!wrongQuestions.length) return;

  // перемешиваем и перемешиваем варианты
  quiz = shuffle(wrongQuestions).map(shuffleQuestionOptions);

  idx = 0;
  answers = new Map();
  meta.mode = "wrong";
  meta.startedAt = new Date().toISOString();

  saveState();
  render();
}

async function startNew(){
  const sheet = document.getElementById('sheetSelect').value;
  const mode = document.getElementById('modeSelect').value;

  if(!API_BASE || API_BASE.includes("PASTE_")) throw new Error("Не вставлен API_BASE (URL Web App).");

  allQuestions = await loadSheet(sheet);
  if(!allQuestions.length) throw new Error("В базе нет вопросов (или они отфильтрованы из-за ошибок answer/вариантов).");

  quiz = pickQuiz(mode);
  idx = 0;
  answers = new Map();
  meta = { sheet, mode, startedAt: new Date().toISOString() };

  document.getElementById('resetBtn').disabled = false;

  saveState();
  render();
}

async function continueSaved(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;

  const state = JSON.parse(raw);
  meta = state.meta;
  idx = state.idx || 0;
  answers = new Map(state.answers || []);

  // подгружаем актуальные вопросы из листа и собираем quiz по сохранённым id
  allQuestions = await loadSheet(meta.sheet);
  const byId = new Map(allQuestions.map(q=>[q.id, q]));
  quiz = (state.quizIds || []).map(id => byId.get(id)).filter(Boolean);

  // если вопросы в таблице поменялись — могло стать меньше
  if(idx >= quiz.length) idx = Math.max(0, quiz.length - 1);

  document.getElementById('sheetSelect').value = meta.sheet;
  document.getElementById('modeSelect').value = meta.mode;
  document.getElementById('resetBtn').disabled = false;

  render();
}

function resetAll(){
  clearState();
  quiz = [];
  idx = 0;
  answers = new Map();
  meta = { sheet: null, mode: null, startedAt: null };
  document.getElementById('resetBtn').disabled = true;
  render();
}

function initSheets(){
  const sel = document.getElementById('sheetSelect');
  sel.innerHTML = SHEETS.map(s=>`<option value="${escapeHtml(s.value)}">${escapeHtml(s.label)}</option>`).join('');
}

document.getElementById('startBtn').onclick = async ()=>{
  try{
    await startNew();
  } catch(e){
    elApp.innerHTML = `<div class="card bad">${escapeHtml(e.message)}</div>`;
  }
};

document.getElementById('continueBtn').onclick = async ()=>{
  try{
    await continueSaved();
  } catch(e){
    elApp.innerHTML = `<div class="card bad">${escapeHtml(e.message)}</div>`;
  }
};

document.getElementById('resetBtn').onclick = resetAll;

initSheets();
updateContinueBtn();
render();
</script>
</body>
</html>

